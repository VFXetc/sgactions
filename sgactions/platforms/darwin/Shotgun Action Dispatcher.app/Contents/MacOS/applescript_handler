#!/usr/bin/env python

import os
import sys
import tempfile
import time

# Dump stdout/err into a tempfile so we can actually get to them.
fd, path = tempfile.mkstemp(dir='/var/tmp', suffix='.txt', prefix='sgactions.%d.' % time.time())
os.dup2(fd, 1)
os.dup2(fd, 2)


# Perform sys.argv emulation. We just assume we are always running from
# LaunchServices.
sys.path.append(os.path.dirname(__file__))
os.environ['_PY2APP_LAUNCHED_'] = '1'
import argv_emulation


# Handoff to environment bootstrapper.
bootstrap = os.path.join(os.path.dirname(__file__), 'bootstrap_environ')
try:
    os.execv(bootstrap, [bootstrap, sys.argv[-1]])
except OSError as e:
    # "Argument list too long"
    if e.errno != 7:
        raise

# Dump it into a temporary file instead.
fd, path = tempfile.mkstemp()
fh = os.fdopen(fd, 'w')
fh.write(sys.argv[-1])
fh.close()
os.execv(bootstrap, [bootstrap, '-f', path])
